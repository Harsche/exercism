name: Merge All Pull Requests

on:
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  merge-all-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Merge PRs sequentially
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching open PRs (oldest first)..."

          prs=$(gh pr list \
            --state open \
            --limit 1000 \
            --json number,createdAt,mergeable \
            --jq 'sort_by(.createdAt) | .[].number')

          if [ -z "$prs" ]; then
            echo "✓ No open PRs found"
            exit 0
          fi

          echo "Found PRs:"
          echo "$prs"
          echo ""

          for pr in $prs; do
            echo "========================================="
            echo "Processing PR #$pr"
            echo "========================================="

            mergeable=$(gh pr view "$pr" --json mergeable --jq '.mergeable')

            if [ "$mergeable" != "MERGEABLE" ]; then
              echo "⚠ PR #$pr is not mergeable (state: $mergeable)"
              echo "Stopping to avoid inconsistent state."
              exit 1
            fi

            echo "Merging PR #$pr..."

            if gh pr merge "$pr" \
              --rebase \
              --delete-branch \
              --auto; then
              echo "✓ PR #$pr merged successfully"
            else
              echo "✗ Failed to merge PR #$pr"
              exit 1
            fi

            echo "Waiting for GitHub to update branch..."
            sleep 5
            echo ""
          done

          echo "========================================="
          echo "✓ All PRs merged successfully"
          echo "========================================="
