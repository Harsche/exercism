name: Merge All Pull Requests

on:  
  workflow_dispatch: # Allows manual trigger from the UI

jobs: 
  merge-prs: 
    runs-on: ubuntu-latest
    permissions:   
      pull-requests: write
      contents:  write

    steps: 
      - name:  Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches

      - name:  Rebase and Merge all open PRs (Oldest First)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Get open PRs, sorted by created date in ascending order (oldest first)
          PR_LIST=$(gh pr list --state open --limit 1000 --json number,createdAt --jq 'sort_by(.createdAt) | .[].number')

          if [ -z "$PR_LIST" ]; then
            echo "No open pull requests found."
            exit 0
          fi

          for PR in $PR_LIST; do
            echo "-----------------------------------"
            echo "Processing oldest PR: #$PR"

            # 2. Get PR branch information
            echo "Getting PR #$PR branch information..."
            HEAD_BRANCH=$(gh pr view $PR --json headRefName -q '. headRefName')
            BASE_BRANCH=$(gh pr view $PR --json baseRefName -q '. baseRefName')
            
            echo "Head branch:  $HEAD_BRANCH"
            echo "Base branch: $BASE_BRANCH"
            
            if [ -z "$HEAD_BRANCH" ] || [ -z "$BASE_BRANCH" ]; then
              echo "Error: Could not get branch information for PR #$PR"
              exit 1
            fi
            
            # 3. Fetch the latest changes
            echo "Fetching latest changes..."
            git fetch origin "$BASE_BRANCH"
            git fetch origin "$HEAD_BRANCH"
            
            # 4. Checkout and rebase the PR branch
            echo "Rebasing $HEAD_BRANCH onto $BASE_BRANCH..."
            git checkout "$HEAD_BRANCH"
            if ! git rebase "origin/$BASE_BRANCH"; then
              echo "Error:  Failed to rebase PR #$PR. There may be merge conflicts."
              echo "Stopping execution to prevent issues."
              git rebase --abort
              exit 1
            fi
            
            # 5. Force push the rebased branch
            echo "Pushing rebased branch..."
            git push origin "$HEAD_BRANCH" --force-with-lease

            # 6. Return to base branch for next iteration
            git checkout "$BASE_BRANCH"

            # 7. Attempt to merge
            echo "Merging PR #$PR..."
            if gh pr merge $PR --rebase --delete-branch; then
              echo "Successfully merged PR #$PR"
              
              # 8. Wait for GitHub to process the merge
              echo "Waiting for GitHub to process the merge..."
              sleep 5
              
              # 9. Update our local base branch after merge
              git fetch origin "$BASE_BRANCH"
              git pull origin "$BASE_BRANCH"
            else
              echo "Error: Failed to merge PR #$PR."
              echo "Stopping execution to prevent out-of-order merging or conflict issues."
              exit 1
            fi
          done

          echo "-----------------------------------"
          echo "All PRs merged successfully!"
