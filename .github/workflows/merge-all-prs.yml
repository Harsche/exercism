name: Merge All Pull Requests

on:
  workflow_dispatch: # Allows manual trigger from the UI

jobs:
  merge-prs:
    runs-on: ubuntu-latest
    permissions: 
      pull-requests: write
      contents: write

    steps: 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Rebase and Merge all open PRs (Oldest First)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Get open PRs, sorted by created date in ascending order (oldest first)
          # We set a high limit (e.g., 1000) to ensure we capture all open PRs
          PR_LIST=$(gh pr list --state open --limit 1000 --json number,createdAt --jq 'sort_by(.createdAt) | .[].number')

          if [ -z "$PR_LIST" ]; then
            echo "No open pull requests found."
            exit 0
          fi

          for PR in $PR_LIST; do
            echo "-----------------------------------"
            echo "Processing oldest PR: #$PR"

            # 2. Update the PR branch to ensure it's in sync with the base branch
            echo "Updating PR #$PR branch..."
            if ! gh pr view $PR --json headRefName,baseRefName -q '"\(.headRefName) \(.baseRefName)"' | read HEAD_BRANCH BASE_BRANCH; then
              HEAD_BRANCH=$(gh pr view $PR --json headRefName -q '.headRefName')
              BASE_BRANCH=$(gh pr view $PR --json baseRefName -q '.baseRefName')
            fi
            
            echo "Head branch: $HEAD_BRANCH, Base branch: $BASE_BRANCH"
            
            # Fetch the latest changes
            git fetch origin $BASE_BRANCH:$BASE_BRANCH || git fetch origin $BASE_BRANCH
            git fetch origin $HEAD_BRANCH:$HEAD_BRANCH || git fetch origin $HEAD_BRANCH
            
            # Checkout and rebase the PR branch
            git checkout $HEAD_BRANCH
            if ! git rebase $BASE_BRANCH; then
              echo "Error: Failed to rebase PR #$PR. There may be merge conflicts."
              echo "Stopping execution to prevent issues."
              git rebase --abort
              exit 1
            fi
            
            # Force push the rebased branch
            git push origin $HEAD_BRANCH --force-with-lease

            # 3. Attempt to merge
            if gh pr merge $PR --rebase --delete-branch; then
              echo "Successfully merged PR #$PR"
            else
              echo "Error: Failed to merge PR #$PR."
              echo "Stopping execution to prevent out-of-order merging or conflict issues."
              exit 1
            fi
          done
